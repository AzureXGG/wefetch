!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e=e||self).wefetch=t()}(this,function(){"use strict";function e(){this.listeners={}}e.prototype.on=function(e,t){e in this.listeners||(this.listeners[e]=[]),this.listeners[e].push(t)},e.prototype.emit=function(e,t){var n=this.listeners[e];n&&n.forEach(function(e){e(t)})};var i=new e;function r(r){return function(n){(n=n||{}).config=n.config||{};for(var e=arguments.length,o=Array(1<e?e-1:0),t=1;t<e;t++)o[t-1]=arguments[t];return new Promise(function(e,t){n.config.eventType?i.emit(n.config.eventType,r.apply(void 0,[Object.assign({},n,{success:e,fail:t})].concat(o))):r.apply(void 0,[Object.assign({},n,{success:e,fail:t})].concat(o))})}}function t(){this.platform=null}t.prototype.getRequest=function(){try{if(wx.request)return this.platform="wx",r(wx.request)}catch(e){try{if(my.request)return this.platform="my",r(my.request);if(my.httpRequest)return this.platform="my",r(my.httpRequest)}catch(e){if(swan.request)return this.platform="swan",r(swan.request)}}},t.prototype.getUpload=function(){return r(this.getPlatform().uploadFile)},t.prototype.getDownload=function(){return r(this.getPlatform().downloadFile)},t.prototype.getPlatform=function(){return"wx"===this.platform?wx:"my"===this.platform?my:"swan"===this.platform?swan:void 0};var u=new t,n="multipart/form-data",o="image/jpeg",f={createRequest:u.getRequest(),header:{"Content-Type":"application/x-www-form-urlencoded;charset=utf-8"},method:"get",timeout:0};function s(o,r){return function(){for(var e=new Array(arguments.length),t=0,n=e.length;t<n;t++)e[t]=arguments[t];return o.apply(r,e)}}var a=Object.prototype.toString,c={type:function(){for(var e={},t=["String","Object","Number","Array","Undefined","Function","Null","Date"],n=0,o=t.length;n<o;n++)!function(t){e["is"+t]=function(e){return a.call(e)==="[object "+t+"]"}}(t[n]);return e}(),forEach:function(e,t){if(e)if("object"!=typeof e&&(e=[e]),this.type.isArray(e))for(var n=0,o=e.length;n<o;n++)t.call(null,e[n],n,e);else for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&t.call(null,e[r],r,e)},merge:function(){var n={};function e(e,t){"object"==typeof n[t]&&"object"==typeof e?n[t]=c.merge(n[t],e):n[t]=e}for(var t=0,o=arguments.length;t<o;t++)this.forEach(arguments[t],e);return n},deepMerge:function(){var n={};function e(e,t){"object"==typeof n[t]&&"object"==typeof e?n[t]=c.deepMerge(n[t],e):n[t]="object"==typeof e?c.deepMerge({},e):e}for(var t=0,o=arguments.length;t<o;t++)this.forEach(arguments[t],e);return n},mergeConfig:function(t,n){var o={};return n=n||{},["url","method","data","config"].forEach(function(e){n[e]&&(o[e]=n[e])}),["header"].forEach(function(e){c.type.isObject(n[e])?o[e]=c.deepMerge(t[e],n[e]):n[e]?o[e]=n[e]:c.type.isObject(t[e])?o[e]=c.deepMerge(t[e]):t[e]&&(o[e]=t[e])}),["baseUrl","timeout","eventType","createRequest"].forEach(function(e){n[e]?o[e]=n[e]:t[e]&&(o[e]=t[e])}),o},extends:function(n,e,o){return this.forEach(e,function(e,t){n[t]=o&&"function"==typeof e?s(e,o):e}),n}};function p(){this.handles=[]}function l(e){return"my"===u.platform&&"download"!==e.method&&"upload"!==e.method&&(e.headers=e.header,delete e.header),"download"===e.method&&(e.method="get",e.createRequest=u.getDownload()),"upload"===e.method&&(e.method="post",e.createRequest=u.getUpload()),(0,e.createRequest)(e).then(function(e){return e},function(e){return Promise.reject(e)})}function h(e){this.defaults=e,this.before=new p,this.after=new p}function d(e){var t=new h(e),n=s(h.prototype.request,t);return c.extends(n,h.prototype,t),c.extends(n,t),n}p.prototype.use=function(e,t){return this.handles.push({fulfilled:e,rejected:t}),this.handles.length-1},p.prototype.eject=function(e){this.handles[e]&&(this.handles[e]=null)},p.prototype.forEach=function(t){this.handles.forEach(function(e){e&&t(e)})},["options","get","head","post","put","delete","trace","connect","postJson"].forEach(function(n){h.prototype[n]=function(e,t){return this.request(c.merge(t||{},{url:e,method:n}))}}),h.prototype.download=function(e,t){return(t=t||{}).header?t.header["Content-Type"]=t.header["Content-Type"]||o:t.header={"Content-Type":o},c.type.isObject(e)?this.request(c.merge(t,e,{method:"download"})):this.request(c.merge(t,{url:e,method:"download"}))},h.prototype.upload=function(e,t){return(t=t||{}).header?t.header["Content-Type"]=t.header["Content-Type"]||n:t.header={"Content-Type":n},c.type.isObject(e)?this.request(t,e,{method:"upload"}):this.request(c.merge(t,{url:e,method:"upload"}))},h.prototype.login=function(){return r(u.getPlatform().login)()},h.prototype.on=function(e,t){i.on(e,t)},h.prototype.abort=function(e,t){this.on(e,function(e){e.abort(),t&&t()})},h.prototype.onProcess=function(e,t){this.on(e,function(e){e.onProgressUpdate(t)})},h.prototype.promisify=r,h.prototype.request=function(e){"string"==typeof e&&((e=arguments[1]||{}).url=arguments[0]),"postJson"===(e=c.mergeConfig(this.defaults,e)).method&&(e.method="post",e.header["Content-Type"]="application/json;charset=utf-8"),-1===e.url.indexOf("http")&&(e.downloadUrl&&"download"===e.method?e.url=e.downloadUrl+e.url:e.uploadUrl&&"upload"===e.method?e.url=e.uploadUrl+e.url:e.url=e.baseUrl+e.url);var t=[l,void 0];e.config=e.config||{};var n=Promise.resolve(e);for(this.before.forEach(function(e){t.unshift(e.fulfilled,e.rejected)}),this.after.forEach(function(e){t.push(e.fulfilled,e.rejected)});t.length;)n=n.then(t.shift(),t.shift());return n},Promise.prototype.finally=function(t){var n=this.constructor;return this.then(function(e){n.resolve(t(e)).then(function(){return e})},function(e){n.resolve(t(value)).then(function(){return Promise.reject(e)})})};var y=d(f);return y.all=function(e){return Promise.all(e)},y.getUserInfo=function(e){var t=u.getPlatform(),n=r(t.getSetting),o=r(t.getUserInfo);return e?n().then(function(e){if(e.authSetting["scope.userInfo"])return o()}):o()},y.retry=function n(o,r,i){if(i=i||1e3,!o&&0!==o||!r)throw new Error("request and times params is required");if("function"!=typeof r)throw new Error("request must be a function, but got a\n"+typeof r);i||(i=0);var u=r();return 1<o?(o--,new Promise(function(e,t){u.then(e).catch(function(){setTimeout(function(){e(n(o,r,i))},i)})})):u},y.create=function(e){return d(c.merge(f,e))},y});
