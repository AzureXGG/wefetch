!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e=e||self).wefetch=t()}(this,function(){"use strict";function e(u){return function(n){for(var e=arguments.length,o=Array(1<e?e-1:0),t=1;t<e;t++)o[t-1]=arguments[t];return new Promise(function(e,t){var r=u.apply(void 0,[Object.assign({},n,{success:e,fail:t})].concat(o));r&&(Promise.prototype.task=r)})}}var n={createRequest:wx.request?e(wx.request):my.httpRequest?e(my.httpRequest):void 0,baseUrl:"",method:"get",header:{"Content-Type":"application/x-www-form-urlencoded;charset=utf-8"}};var o=Object.prototype.toString,u={type:function(){for(var e={},t=["String","Object","Number","Array","Undefined","Function","Null","Date"],r=0,n=t.length;r<n;r++)!function(t){e["is"+t]=function(e){return o.call(e)==="[object "+t+"]"}}(t[r]);return e}(),forEach:function(e,t){if(e)if("object"!=typeof e&&(e=[e]),Array.isArray(e))for(var r=0,n=e.length;r<n;r++)t.call(null,e[r],r,e);else for(var o in e)Object.prototype.hasOwnProperty.call(e,o)&&t.call(null,e[o],o,e)},merge:function(){var r={};function e(e,t){"object"==typeof r[t]&&"object"==typeof e?r[t]=u.merge(r[t],e):r[t]=e}for(var t=0,n=arguments.length;t<n;t++)this.forEach(arguments[t],e);return r},extends:function(r,e,n){return this.forEach(e,function(e,t){r[t]=n&&"function"===e?u.bind(e,n):e}),r}};function t(){this.handles=[]}function i(e){return(0,e.createRequest)(e).then(function(e){return e},function(e){if(e)return e})}function l(e){this.defaults=e}function r(e){var n,o,t=new l(e),r=(n=l.prototype.request,o=t,function(){for(var e=new Array(arguments.length),t=0,r=e.length;t<r;t++)e[t]=arguments[t];return n.apply(o,e)});return u.extends(r,l.prototype,t),u.extends(r,t),r}t.prototype.use=function(e,t){this.handles.push({fulfilled:e,rejected:t})},t.prototype.eject=function(e){this.handles[e]&&(this.handles[e]=null)},t.prototype.forEach=function(t){u.forEach(this.handles,function(e){e&&t(e)})},u.forEach(["options","get","head","post","put","delete","trace","connect","postJson"],function(e){l.prototype[e]=function(e,t,r){return this.request(u.merge(r||{},{url:e,data:t,config:r}))}}),l.prototype.download=function(e,t,r){var n={},o=e;return n.header={"Content-Type":"image/jpeg"},n._is_download_request=!0,n.createRequest=this.promisify(wx.downloadFile),u.type.isObject(o)?(r=u.merge(n,o),n=null,this.request(u.merge(r,{url:o.url?o.url:"",filePath:o.filePath,config:r}))):o?(r=u.merge(n,r||{}),n=null,this.request(u.merge(r,{url:e,filePath:t?t.filePath:void 0,config:r}))):(r=u.merge(n),n=null,this.request(u.merge(r,{url:""})))},l.prototype.upload=function(e,t,r){t=t||{};var n={header:{"Content-Type":"multipart/form-data"},_is_upload_request:!0};return n.createRequest=this.promisify(wx.uploadFile),u.type.isObject(e)?(r=u.merge(n,e),n=null,this.request(u.merge(r,{url:e.url?e.url:"",method:"post",filePath:e.filePath,name:e.name,formData:e.formData,config:r}))):(r=u.merge(n,r||{}),n=null,this.request(u.merge(r,{url:e,method:"post",filePath:t.filePath,name:t.name,formData:t.formData,config:r})))},l.prototype.promisify=e,l.prototype.before=new t,l.prototype.after=new t,l.prototype.request=function(e){if(void 0!==e.url&&null!==e.url){"postJson"===(e=u.merge(n,this.defaults,e,{method:"get"})).method&&(e.method="post",e.header["Content-Type"]="application/json;charset=utf-8"),-1===e.url.indexOf("http")&&(e.downloadUrl&&e._is_download_request?e.url=e.downloadUrl+e.url:e.uploadUrl&&e._is_upload_request?e.url=e.uploadUrl+e.url:e.url=e.baseUrl+e.url);var t=[i,void 0],r=Promise.resolve(e);for(this.before.forEach(function(e){t.unshift(e.fulfilled,e.rejectd)}),this.after.forEach(function(e){t.push(e.fulfilled,e.rejectd)});t.length;)r=r.then(t.shift(),t.shift());return r}console.error("the request url is undefined")},Promise.prototype.finally=function(t){var r=this.constructor;return this.then(function(e){r.resolve(t(e)).then(function(){return e})},function(e){r.resolve(t(value)).then(function(){throw e})})};var f=r(n);return f.create=function(e){return r(u.merge(n,e))},f});
