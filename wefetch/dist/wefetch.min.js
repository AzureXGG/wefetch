!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t=t||self).wefetch=e()}(this,function(){"use strict";function t(){this.listeners={}}t.prototype.on=function(t,e){t in this.listeners||(this.listeners[t]=[]),this.listeners[t].push(e)},t.prototype.emit=function(t,e){var n=this.listeners[t];n&&n.forEach(function(t){t(e)})};var i=new t;function e(r){return function(n){(n=n||{}).config=n.config||{};for(var t=arguments.length,o=Array(1<t?t-1:0),e=1;e<t;e++)o[e-1]=arguments[e];return new Promise(function(t,e){n.config.eventType?i.emit(n.config.eventType,r.apply(void 0,[Object.assign({},n,{success:t,fail:e})].concat(o))):r.apply(void 0,[Object.assign({},n,{success:t,fail:e})].concat(o))})}}function n(){this.platform=null}n.prototype.getRequest=function(){try{if(wx.request)return this.platform="wx",e(wx.request)}catch(t){try{if(my.request)return this.platform="my",e(my.request);if(my.httpRequest)return this.platform="my",e(my.httpRequest)}catch(t){try{if(tt.request)return this.platform="tt",e(tt.request)}catch(t){if(swan.request)return this.platform="swan",e(swan.request)}}}},n.prototype.getUpload=function(){return e(this.getPlatform().uploadFile)},n.prototype.getDownload=function(){return e(this.getPlatform().downloadFile)},n.prototype.getPlatform=function(){return"wx"===this.platform?wx:"my"===this.platform?my:"swan"===this.platform?swan:"tt"===this.platform?tt:void 0};var o=new n,r={createRequest:o.getRequest(),header:{},config:{},method:"get",timeout:0};function u(o,r){return function(){for(var t=new Array(arguments.length),e=0,n=t.length;e<n;e++)t[e]=arguments[e];return o.apply(r,t)}}var f=Object.prototype.toString,s={type:function(){for(var t={},e=["String","Object","Number","Array","Undefined","Function","Null","Date"],n=0,o=e.length;n<o;n++)!function(e){t["is"+e]=function(t){return f.call(t)==="[object "+e+"]"}}(e[n]);return t}(),normalizeHeaderName:function(t){for(var e in t)/Content-Type/gi.test(e)&&(t["Content-Type"]=t[e],delete t[e])},forEach:function(t,e){if(t)if("object"!=typeof t&&(t=[t]),this.type.isArray(t))for(var n=0,o=t.length;n<o;n++)e.call(null,t[n],n,t);else for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&e.call(null,t[r],r,t)},merge:function(){var n={};function t(t,e){"object"==typeof n[e]&&"object"==typeof t?n[e]=s.merge(n[e],t):n[e]=t}for(var e=0,o=arguments.length;e<o;e++)this.forEach(arguments[e],t);return n},deepMerge:function(){var n={};function t(t,e){"object"==typeof n[e]&&"object"==typeof t?n[e]=s.deepMerge(n[e],t):n[e]="object"==typeof t?s.deepMerge({},t):t}for(var e=0,o=arguments.length;e<o;e++)this.forEach(arguments[e],t);return n},mergeConfig:function(e,n){var o={};return n=n||{},["url","method","data","config"].forEach(function(t){n[t]&&(o[t]=n[t])}),["header","headers"].forEach(function(t){s.type.isObject(n[t])?o[t]=s.deepMerge(e[t],n[t]):n[t]?o[t]=n[t]:s.type.isObject(e[t])?o[t]=s.deepMerge(e[t]):e[t]&&(o[t]=e[t])}),["baseUrl","timeout","eventType","createRequest"].forEach(function(t){void 0!==n[t]?o[t]=n[t]:void 0!==e[t]&&(o[t]=e[t])}),o},extends:function(n,t,o){return this.forEach(t,function(t,e){n[e]=o&&"function"==typeof t?u(t,o):t}),n}};function a(){this.handles=[]}function c(t){return s.normalizeHeaderName(t.header||t.headers),"download"===t.method&&(t.method="get",t.createRequest=o.getDownload()),"upload"===t.method&&(t.method="post",t.createRequest=o.getUpload()),(0,t.createRequest)(t).then(function(t){return t},function(t){return Promise.reject(t)})}function l(t){this.defaults=t,this.before=new a,this.after=new a}function h(t){var e=new l(t),n=u(l.prototype.request,e);return s.extends(n,l.prototype,e),s.extends(n,e),n}a.prototype.use=function(t,e){return this.handles.push({fulfilled:t,rejected:e}),this.handles.length-1},a.prototype.eject=function(t){this.handles[t]&&(this.handles[t]=null)},a.prototype.forEach=function(e){this.handles.forEach(function(t){t&&e(t)})},["options","get","head","post","put","delete","trace","connect"].forEach(function(n){l.prototype[n]=function(t,e){return this.request(s.merge(e||{},{url:t,method:n}))}}),l.prototype.download=function(t,e){return s.type.isObject(t)?this.request(s.merge(t,{method:"download"})):this.request(s.merge(e||{},{url:t,method:"download"}))},l.prototype.upload=function(t,e){return s.type.isObject(t)?this.request(t,{method:"upload"}):this.request(s.merge(e||{},{url:t,method:"upload"}))},l.prototype.on=function(t,e){i.on(t,e)},l.prototype.abort=function(t,e){this.on(t,function(t){t.abort(),e&&e()})},l.prototype.onProcess=function(t,e){this.on(t,function(t){t.onProgressUpdate(e)})},l.prototype.promisify=e,l.prototype.request=function(t){"string"==typeof t&&((t=arguments[1]||{}).url=arguments[0]),-1===(t=s.mergeConfig(this.defaults,t)).url.indexOf("http")&&(t.downloadUrl&&"download"===t.method?t.url=t.downloadUrl+t.url:t.uploadUrl&&"upload"===t.method?t.url=t.uploadUrl+t.url:t.url=t.baseUrl+t.url),"my"===o.platform&&"download"!==t.method&&"upload"!==t.method&&(t.headers=Object.assign({},t.header),delete t.header);var e=[c,void 0],n=Promise.resolve(t);for(this.before.forEach(function(t){e.unshift(t.fulfilled,t.rejected)}),this.after.forEach(function(t){e.push(t.fulfilled,t.rejected)});e.length;)n=n.then(e.shift(),e.shift());return n},Promise.prototype.finally=function(e){var n=this.constructor;return this.then(function(t){n.resolve(e(t)).then(function(){return t})},function(t){n.resolve(e(value)).then(function(){return Promise.reject(t)})})};var p=h(r);return p.all=function(t){return Promise.all(t)},p.retry=function n(o,r,i){if(i=i||1e3,!o&&0!==o||!r)throw new Error("request and times params is required");if("function"!=typeof r)throw new Error("request must be a function, but got a\n"+typeof r);var u=r();return 1<o?(o--,new Promise(function(t,e){u.then(t).catch(function(){setTimeout(function(){t(n(o,r,i))},i)})})):u},p.create=function(t){return h(s.merge(r,t))},p});
