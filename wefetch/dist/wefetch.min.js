!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e=e||self).wefetch=t()}(this,function(){"use strict";function n(o){return function(n){for(var e=arguments.length,r=Array(1<e?e-1:0),t=1;t<e;t++)r[t-1]=arguments[t];return new Promise(function(e,t){Promise.prototype.task=o.apply(void 0,[Object.assign({},n,{success:e,fail:t})].concat(r))})}}function o(e,t){return{promisify:n(e),type:r,platform:t}}function i(e,t){return{promisify:n(e),type:u,platform:t}}var r="multipart/form-data",u="image/jpeg",l={createRequest:(wx.request,wx.request?n(wx.request):my.httpRequest?n(my.httpRequest):swan.request?n(swan.request):void 0),header:{"Content-Type":"application/x-www-form-urlencoded;charset=utf-8"},timeout:0};var a=Object.prototype.toString,s={type:function(){for(var e={},t=["String","Object","Number","Array","Undefined","Function","Null","Date"],n=0,r=t.length;n<r;n++)!function(t){e["is"+t]=function(e){return a.call(e)==="[object "+t+"]"}}(t[n]);return e}(),forEach:function(e,t){if(e)if("object"!=typeof e&&(e=[e]),Array.isArray(e))for(var n=0,r=e.length;n<r;n++)t.call(null,e[n],n,e);else for(var o in e)Object.prototype.hasOwnProperty.call(e,o)&&t.call(null,e[o],o,e)},merge:function(){var n={};function e(e,t){"object"==typeof n[t]&&"object"==typeof e?n[t]=s.merge(n[t],e):n[t]=e}for(var t=0,r=arguments.length;t<r;t++)this.forEach(arguments[t],e);return n},extends:function(n,e,r){return this.forEach(e,function(e,t){n[t]=r&&"function"===e?s.bind(e,r):e}),n}};function t(){this.handles=[]}t.prototype.use=function(e,t){this.handles.push({fulfilled:e,rejected:t})},t.prototype.eject=function(e){return this.handles[e]&&(this.handles[e]=null),this.handles.length-1},t.prototype.forEach=function(t){this.handles.forEach(function(e){e&&t(e)})};var f={is_up:null,is_down:null};function p(e){return(0,e.createRequest)(e).then(function(e){return e},function(e){if(e)return e})}function c(e){this.defaults=e,this.before=new t,this.after=new t}function d(e){var r,o,t=new c(e),n=(r=c.prototype.request,o=t,function(){for(var e=new Array(arguments.length),t=0,n=e.length;t<n;t++)e[t]=arguments[t];return r.apply(o,e)});return s.extends(n,c.prototype,t),s.extends(n,t),n}["options","get","head","post","put","delete","trace","connect","postJson"].forEach(function(r){c.prototype[r]=function(e,t,n){return this.request(s.merge(n||{},{url:e,data:t,method:r,config:n}))}}),c.prototype.download=function(e,t,n){f.is_down=!0,t=t||{},n=n||{};var r=wx.downloadFile?i(wx.downloadFile,"wx"):my.downloadFile?i(my.downloadFile,"my"):swan.downloadFile?i(swan.downloadFile,"swan"):void 0;return n.createRequest=r.promisify,n.header?n.header["Content-Type"]=n.header["Content-Type"]||r.type:n.header={"Content-Type":r.type},s.type.isObject(e)?this.request(s.merge(n,e,{url:e.url?e.url:"",filePath:e.filePath})):this.request(s.merge(n,{url:e,filePath:t?t.filePath:void 0,config:n}))},c.prototype.upload=function(e,t,n){f.is_up=!0,t=t||{},n=n||{};var r=wx.uploadFile?o(wx.uploadFile,"wx"):my.uploadFile?o(my.uploadFile,"my"):swan.uploadFile?o(swan.uploadFile,"swan"):void 0;return n.createRequest=r.promisify,n.header?n.header["Content-Type"]=n.header["Content-Type"]||r.type:n.header={"Content-Type":r.type},s.type.isObject(e)?this.request(s.merge(n,e,{url:e.url?e.url:"",method:"post",filePath:e.filePath,name:e.name,formData:e.formData})):this.request(s.merge(n,{url:e,method:"post",filePath:t.filePath,name:t.name,formData:t.formData,config:n}))},c.prototype.promisify=n,c.prototype.request=function(e){if(void 0!==e.url&&null!==e.url){"postJson"===(e=s.merge(l,this.defaults,{method:"get"},e)).method&&(e.method="post",e.header["Content-Type"]="application/json;charset=utf-8"),-1===e.url.indexOf("http")&&(e.downloadUrl&&f.is_down?e.url=e.downloadUrl+e.url:e.uploadUrl&&f.is_up?e.url=e.uploadUrl+e.url:e.url=e.baseUrl+e.url);var t=[p,void 0],n=Promise.resolve(e);for(this.before.forEach(function(e){t.unshift(e.fulfilled,e.rejectd)}),this.after.forEach(function(e){t.push(e.fulfilled,e.rejectd)});t.length;)n=n.then(t.shift(),t.shift());return f.is_up=null,f.is_down=null,n}console.error("the request url is undefined")},Promise.prototype.finally=function(t){var n=this.constructor;return this.then(function(e){n.resolve(t(e)).then(function(){return e})},function(e){n.resolve(t(value)).then(function(){throw e})})};var e=d(l);return e.all=function(e){return Promise.all(e)},e.create=function(e){return d(s.merge(l,e))},e});
