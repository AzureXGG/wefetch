!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t=t||self).wefetch=e()}(this,function(){"use strict";function t(){this.listeners={}}t.prototype.on=function(t,e){t in this.listeners||(this.listeners[t]=[]),this.listeners[t].push(e)},t.prototype.emit=function(t,e){var o=this.listeners[t];o&&o.forEach(function(t){t(e)})};var i=new t;function e(r){return function(o){(o=o||{}).config=o.config||{};for(var t=arguments.length,n=Array(1<t?t-1:0),e=1;e<t;e++)n[e-1]=arguments[e];return new Promise(function(t,e){o.config.eventType?i.emit(o.config.eventType,r.apply(void 0,[Object.assign({},o,{success:t,fail:e})].concat(n))):r.apply(void 0,[Object.assign({},o,{success:t,fail:e})].concat(n))})}}function o(){this.platform=null}o.prototype.getRequest=function(){try{if(wx.request)return this.platform="wx",e(wx.request)}catch(t){try{if(my.request)return this.platform="my",e(my.request);if(my.httpRequest)return this.platform="my",e(my.httpRequest)}catch(t){try{if(tt.request)return this.platform="tt",e(tt.request)}catch(t){if(swan.request)return this.platform="swan",e(swan.request)}}}},o.prototype.getUpload=function(){return e(this.getPlatform().uploadFile)},o.prototype.getDownload=function(){return e(this.getPlatform().downloadFile)},o.prototype.getPlatform=function(){return"wx"===this.platform?wx:"my"===this.platform?my:"swan"===this.platform?swan:"tt"===this.platform?tt:void 0};var n=new o,r={createRequest:n.getRequest(),header:{},config:{},method:"get",timeout:0};function u(n,r){return function(){for(var t=new Array(arguments.length),e=0,o=t.length;e<o;e++)t[e]=arguments[e];return n.apply(r,t)}}var f=Object.prototype.toString,s={type:function(){for(var t={},e=["String","Object","Number","Array","Undefined","Function","Null","Date"],o=0,n=e.length;o<n;o++)!function(e){t["is"+e]=function(t){return f.call(t)==="[object "+e+"]"}}(e[o]);return t}(),forEach:function(t,e){if(t)if("object"!=typeof t&&(t=[t]),this.type.isArray(t))for(var o=0,n=t.length;o<n;o++)e.call(null,t[o],o,t);else for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&e.call(null,t[r],r,t)},merge:function(){var o={};function t(t,e){"object"==typeof o[e]&&"object"==typeof t?o[e]=s.merge(o[e],t):o[e]=t}for(var e=0,n=arguments.length;e<n;e++)this.forEach(arguments[e],t);return o},deepMerge:function(){var o={};function t(t,e){"object"==typeof o[e]&&"object"==typeof t?o[e]=s.deepMerge(o[e],t):o[e]="object"==typeof t?s.deepMerge({},t):t}for(var e=0,n=arguments.length;e<n;e++)this.forEach(arguments[e],t);return o},mergeConfig:function(e,o){var n={};return o=o||{},["url","method","data","config"].forEach(function(t){o[t]&&(n[t]=o[t])}),["header","headers"].forEach(function(t){s.type.isObject(o[t])?n[t]=s.deepMerge(e[t],o[t]):o[t]?n[t]=o[t]:s.type.isObject(e[t])?n[t]=s.deepMerge(e[t]):e[t]&&(n[t]=e[t])}),["baseUrl","timeout","eventType","createRequest"].forEach(function(t){void 0!==o[t]?n[t]=o[t]:void 0!==e[t]&&(n[t]=e[t])}),n},extends:function(o,t,n){return this.forEach(t,function(t,e){o[e]=n&&"function"==typeof t?u(t,n):t}),o}};function c(){this.handles=[]}function a(t){return"download"===t.method&&(t.method="get",t.createRequest=n.getDownload()),"upload"===t.method&&(t.method="post",t.createRequest=n.getUpload()),(0,t.createRequest)(t).then(function(t){return t},function(t){return Promise.reject(t)})}function l(t){this.defaults=t,this.before=new c,this.after=new c}function h(t){var e=new l(t),o=u(l.prototype.request,e);return s.extends(o,l.prototype,e),s.extends(o,e),o}c.prototype.use=function(t,e){return this.handles.push({fulfilled:t,rejected:e}),this.handles.length-1},c.prototype.eject=function(t){this.handles[t]&&(this.handles[t]=null)},c.prototype.forEach=function(e){this.handles.forEach(function(t){t&&e(t)})},["options","get","head","post","put","delete","trace","connect"].forEach(function(o){l.prototype[o]=function(t,e){return this.request(s.merge(e||{},{url:t,method:o}))}}),l.prototype.download=function(t,e){return s.type.isObject(t)?this.request(s.merge(t,{method:"download"})):this.request(s.merge(e||{},{url:t,method:"download"}))},l.prototype.upload=function(t,e){return s.type.isObject(t)?this.request(t,{method:"upload"}):this.request(s.merge(e||{},{url:t,method:"upload"}))},l.prototype.on=function(t,e){i.on(t,e)},l.prototype.abort=function(t,e){this.on(t,function(t){t.abort(),e&&e()})},l.prototype.onProcess=function(t,e){this.on(t,function(t){t.onProgressUpdate(e)})},l.prototype.promisify=e,l.prototype.request=function(t){"string"==typeof t&&((t=arguments[1]||{}).url=arguments[0]),-1===(t=s.mergeConfig(this.defaults,t)).url.indexOf("http")&&(t.downloadUrl&&"download"===t.method?t.url=t.downloadUrl+t.url:t.uploadUrl&&"upload"===t.method?t.url=t.uploadUrl+t.url:t.url=t.baseUrl+t.url),"my"===n.platform&&"download"!==t.method&&"upload"!==t.method&&(t.headers=Object.assign({},t.header),delete t.header);var e=[a,void 0],o=Promise.resolve(t);for(this.before.forEach(function(t){e.unshift(t.fulfilled,t.rejected)}),this.after.forEach(function(t){e.push(t.fulfilled,t.rejected)});e.length;)o=o.then(e.shift(),e.shift());return o},Promise.prototype.finally=function(e){var o=this.constructor;return this.then(function(t){o.resolve(e(t)).then(function(){return t})},function(t){o.resolve(e(value)).then(function(){return Promise.reject(t)})})};var p=h(r);return p.all=function(t){return Promise.all(t)},p.retry=function o(n,r,i){if(i=i||1e3,!n&&0!==n||!r)throw new Error("request and times params is required");if("function"!=typeof r)throw new Error("request must be a function, but got a\n"+typeof r);var u=r();return 1<n?(n--,new Promise(function(t,e){u.then(t).catch(function(){setTimeout(function(){t(o(n,r,i))},i)})})):u},p.create=function(t){return h(s.merge(r,t))},p});
